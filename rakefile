require_relative './business/adapter/twitter_adapter'
require_relative './business/converter/twitter_converter'
require_relative './business/converter/random_converter'
require_relative './business/adapter/random_adapter'
require_relative './helper/DAO'
require_relative './helper/websocket_server'
require 'json'

task :default => [:initialize_websocket_server]

desc "Starts the WebSocket server"
task :initialize_websocket_server do

	ws = WebSocketServer.new
	ws.start

end

desc "Retrieves tweets from the Twitter Streaming API"
task :twitter_adapter do
	
	ta = TwitterAdapter.new
	ta.connect_stream
	
end

desc "Retrieves random phrases from a RPG"
task :random_adapter do

	ra = RandomAdapter.new
	ra.connect_stream

end

desc "Converts tweets into messages whose are catched from redis, then they're converted into Atom and finally they're delivered"
task :twitter_converter do

	dao = DAO.new 'twitter'

	while true

		status = dao.get_status
		puts 'Status retrieved'

		while status != nil
			
			tc = TwitterConverter.new
			usmf = tc.to_usmf status

			dao.publish usmf.to_hash.to_json
			puts 'Publishing'
			
			status = dao.get_status

		end

		puts 'All the statuses were been sent'
		sleep 10
	
	end

end

desc "Converts random phrases into messages"
task :random_converter do

	dao = DAO.new 'random'
	
	while true
		
		status = dao.get_status
		puts 'Status retrieved'
		
		while status != nil
		
			rc = RandomConverter.new
			usmf = rc.to_usmf status
			
			dao.publish usmf.to_hash.to_json
			puts 'Publishing'
			
			status = dao.get_status
		
		end

		puts 'All the statuses were been sent'
		sleep 10

	end

end